---
title: "Changing the time to culling in a growth scenario"
author: "Cale Basaraba & Kate Royce"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=10, fig.height=6, warning = FALSE)
library(metaflu)
library(ggplot2)
library(dplyr)
library(doMC)
library(tidyr)
library(purrr)
library(gridExtra)
library(abind)
registerDoMC(cores = 20)
devtools::install_github("renozao/doRNG", force = TRUE)
set.seed(123)
```


### Introduction

The following simulation includes the following scenario options:

- Non-linear Contact Rate ($\rho, \beta$)

- Clustered Intensification in Growth Scenario

- Paired Networks: Initial / Growth Scenarios have same set of stochastic networks

- Poisson distribution with 40 as mean number of chickens per farm

- 100 Farms

- One initial seeded infection


```{r network-setup}
#Set number of farms and ~ number of chickens per farm
farm_number <- 100
farm_size <- 40

```

#### Parameters

$\beta$ = 1.4456 -- Contact rate implemented alongside $\rho$

$\gamma$ = 0.167 -- Recovery rate

$\mu$ = 0.0 -- Base mortality rate

$\alpha$ = 0.4 -- Disease mortality rate

$\phi$ = 0.0 -- Infectiousness of environmental virions

$\eta$ = 0.0 -- Degradation of environmental virions

$\nu$ = 0.0 -- Update rate of environmental virions

$\sigma$ = 0.0 -- Virion shedding rate

$\omega$ = 0.03 -- Inter-patch movement rate

$\rho$ = 0.8526 -- Contact non-linearity parameter

$\lambda$ = 0.0 -- External force of infection

$\tau$-crit = 0.0 -- Critical surveillance time

$I$-crit = 0.0 -- Threshold for reporting

$\pi$-report = 0.0 -- Reporting probability

$\pi$-detect = 0.0 -- Detection probability

t-detect = variable -- Time to culling

```{r parameter-setup}
  parms = list(
    beta = 1.44456,   #contact rate for direct transmission
    gamma = 0.167,  #recovery rate
    mu = 0,         #base mortality rate
    alpha = 0.4,      #disease mortality rate
    phi = 0,  #infectiousness of environmental virions
    eta = 0,     #degradation rate of environmental virions
    nu =  0.00,    #uptake rate of environmental virion
    sigma = 0,      #virion shedding rate
    omega = 0.03,   #movement rate
    rho = 0.85256,        #contact  nonlinearity 0=dens-dependent, 1=freq-dependent
    lambda = 0,     #force of infection from external sources
    tau_crit = 5,   #critical suveillance time
    I_crit = 1,     #threshold for reporting
    pi_report = 0.9, #reporting probability
    pi_detect = 0.9, #detection probability
    cull_time = 0,   #time to detect (changed in this experiment)
    network_type = "smallworld",
    network_parms = list(dim = 1, size = farm_number, nei = 2.33, p = 0.0596, multiple = FALSE, loops = FALSE),
    stochastic_network = TRUE
    )
```


### Varying culling parameters

This experiment investigates how varying t-detect from 1 to 20 days changes the severity of the epidemic, as measured by the mean number of infections and how widespread the outbreak was.

```{r vary-tdetect}

cull_time_vector <- c(1:20)

results_list <- lapply(cull_time_vector, function(x){
  parms["cull_time"] <- x
  sims <- 100
  g_list <- mclapply(seq_len(sims), function(y){
    patches <- grow_patches_clustered(basic_patches(40,100))
    i_patches <- seed_initial_infection(patches)
    return(mf_sim(init = i_patches, parameters = parms, times=1:365, n_sims = 1))
  }, mc.cores = 20 )

  return(do.call("abind", g_list))
})
```

This graph shows the total number of infections (representing the severity of the outbreak) for each value of t-detect.

```{r infections-plot}
tot_i_list <- lapply(results_list, function(x) get_tot_infections_array(x))
means <- sapply(tot_i_list, function(x) mean(x$total_i))
infection_df <- data.frame(cull_time_vector, mean_infections = means)
ggplot(data = infection_df) + geom_point(aes(x = cull_time_vector, y = mean_infections)) +
  labs(x = "days to culling", y = "mean number of infections")
```

This graph shows the proportion of outbreaks that spread to more than 1 farm for each value of t-detect.
```{r outbreaks-plot}
farm_num <- lapply(results_list, function(x) get_number_farms(x))

outbreak_list <- unlist(lapply(farm_num, function(x){
  return(sum(x > 1)/length(x))
}))

outbreak_df <- data.frame(cull_time_vector, outbreak_list)
outbreaks <- ggplot(data = outbreak_df) +
  geom_point(aes(x = cull_time_vector, y = outbreak_list)) +
  labs(x = "days to culling", y = "proportion of large outbreaks")
plot(outbreaks)
```

A third idea was graphing SIR curves for each value of t-detect, but this was too time- and output-heavy to implement and was replaced by graphing exposure and duration, as well as the loss and farm proportion outlined above, in the final vary-parameters functions found in summarizing_functions.


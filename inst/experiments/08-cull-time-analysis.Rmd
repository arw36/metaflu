---
title: "Growth Scenario - One Initial Infection Seeded, Non-Linear Contact Rate, Clustered Intensification, Paired Networks"
author: "Cale Basaraba"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=10, fig.height=6, warning = FALSE)
library(metaflu)
library(ggplot2)
library(dplyr)
library(doMC)
library(tidyr)
library(purrr)
library(gridExtra)
library(abind)
registerDoMC(cores = 20)
devtools::install_github("renozao/doRNG", force = TRUE)
set.seed(123)
```


### Introduction

The following simulation includes the following scenario options:

- Non-linear Contact Rate ($\rho, \beta$)

- Clustered Intensification in Growth Scenario

- Paired Networks: Initial / Growth Scenarios have same set of stochastic networks

- Poisson distribution with 40 as mean number of chickens per farm

- 100 Farms

- One initial seeded infection


```{r network-setup}
#Set number of farms and ~ number of chickens per farm
farm_number <- 100
farm_size <- 40

```

#### Parameters

$\beta$ = 1.4456 -- Contact rate implemented alongside $\rho$

$\gamma$ = 0.167 -- Recovery rate

$\mu$ = 0.0 -- Base mortality rate

$\alpha$ = 0.4 -- Disease mortality rate

$\phi$ = 0.0 -- Infectiousness of environmental virions

$\eta$ = 0.0 -- Degradation of environmental virions

$\nu$ = 0.0 -- Update rate of environmental virions

$\sigma$ = 0.0 -- Virion shedding rate

$\omega$ = 0.03 -- Inter-patch movement rate

$\rho$ = 0.8526 -- Contact non-linearity parameter

$\lambda$ = 0.0 -- External force of infection

$\tau$-crit = 0.0 -- Critical surveillance time

$I$-crit = 0.0 -- Threshold for reporting

$\pi$-report = 0.0 -- Reporting probability

$\pi$-detect = 0.0 -- Detection probability

t-detect = variable -- Time to cull

```{r parameter-setup}
  parms = list(
    beta = 1.44456,   #contact rate for direct transmission
    gamma = 0.167,  #recovery rate
    mu = 0,         #base mortality rate
    alpha = 0.4,      #disease mortality rate
    phi = 0,  #infectiousness of environmental virions
    eta = 0,     #degradation rate of environmental virions
    nu =  0.00,    #uptake rate of environmental virion
    sigma = 0,      #virion shedding rate
    omega = 0.03,   #movement rate
    rho = 0.85256,        #contact  nonlinearity 0=dens-dependent, 1=freq-dependent
    lambda = 0,     #force of infection from external sources
    tau_crit = 5,   #critical suveillance time
    I_crit = 1,     #threshold for reporting
    pi_report = 0.1, #reporting probability
    pi_detect = 0.9, #detection probability
    cull_time = 1,   #time to detect
    network_type = "smallworld",
    network_parms = list(dim = 1, size = farm_number, nei = 2.33, p = 0.0596, multiple = FALSE, loops = FALSE),
    stochastic_network = TRUE
    )
```


### Growth Run

Eleven percent of farms have grown in size by an order of magnititude, resulting in the doubling of total chicken population in the system. This intensification occurs in the same region.

```{r growth-run}
#Grow an adjacent set of patches to get double total chicken population

grow_patches_clustered <- function(old_condition){
  s_num <- round(nrow(old_condition)*1/9)
  old_condition[1:s_num,1] <- old_condition[1:s_num,1]*10
  return(old_condition)
}

grow_patches_random <- function(old_condition){
  s_num <- round(nrow(old_condition)*1/9)
  random_numbers <- sample.int(nrow(old_condition), s_num)
  old_condition[random_numbers,1] <- old_condition[random_numbers,1]*10
  return(old_condition)
}

cull_time_vector <- c(1:10)

results_list <- lapply(cull_time_vector, function(x){
  parms["cull_time"] <- x
  sims <- 1000
  g_list <- mclapply(seq_len(sims), function(y){
    patches <- grow_patches_clustered(basic_patches(40,100))
    i_patches <- seed_initial_infection(patches)
    return(mf_sim(init = i_patches, parameters = parms, times=1:365, n_sims = 1))
  }, mc.cores = 20 )

  return(do.call("abind", g_list))
})

#testing code

patches <- grow_patches_clustered(basic_patches(40,100))
    i_patches <- seed_initial_infection(patches)
    mf_sim(init = i_patches, parameters = parms, times=1:365, n_sims = 1000)


```

```{r assign-variables}
#results_list <- data.frame(results_list)
#is.data.frame(results_list) # returns TRUE, results_list is a DF
gdurations <- get_duration_array(results_list[[1]])


gs.df <- get_all_sims("S", results_list[[1]])
gi.df <- get_all_sims("I", results_list[[1]])
gr.df <- get_all_sims("R", results_list[[1]])

gfarm_no <- get_number_farms(results_list)

gtot_i <- get_tot_infections_array(results_list)

rm(results_list)

```

```{r plots-growth, message = FALSE}
l <- length(gtot_i$total_i)

gsir.df <- ggplot() +
  geom_line(data = gs.df, aes(x = time, y = pop, group = sim), alpha = 0.05, color = "blue") +
  geom_line(data = gi.df, aes(x = time, y = pop, group = sim), alpha = 0.05, color = "red") +
  geom_line(data = gr.df, aes(x = time, y = pop, group = sim), alpha = 0.05, color = "green") +
  labs(title = paste0("Results from ", l," Simulations"), x = "Time", y = "Population") +
  scale_colour_manual(name = "Compartment", values=c(S = "blue", I = "red", R = "green")) +
  theme_minimal()

gtotal_i <- ggplot() +
  geom_histogram(data = gtot_i, aes(x = total_i), bins = 100) +
  labs(title = "Infections", x = "Infections", y = "Number of Simulations") +
  theme_minimal()

gfarm_numbers <- ggplot() +
  geom_histogram(aes(x = gfarm_no), bins = 100) +
  labs(title = "Farm Spread", x = "Farms Infected", y = "Number of Simulations") +
  coord_flip() +
  theme_minimal()

gduration <- ggplot() +
  geom_histogram(data = gdurations, aes(x = duration), bins = 100) +
  theme_minimal() +
  labs(title = "Duration of Epidemic", x = "Duration in Days", y = "Number of Simulations")

lay <- rbind(c(1,1,1,4),
             c(1,1,1,4),
             c(2,2,3,3))

grid.arrange(gsir.df,gtotal_i,gduration,gfarm_numbers, layout_matrix = lay)

```



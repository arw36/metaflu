---
title: "Changing the time to culling in a growth scenario"
author: "Cale Basaraba & Kate Royce"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=10, fig.height=6, warning = FALSE)
library(metaflu)
library(ggplot2)
library(dplyr)
library(doMC)
library(tidyr)
library(purrr)
library(gridExtra)
library(abind)
registerDoMC(cores = 20)
devtools::install_github("renozao/doRNG", force = TRUE)
set.seed(123)
```


### Introduction

The following simulation includes the following scenario options:

- Non-linear Contact Rate ($\rho, \beta$)

- Clustered Intensification in Growth Scenario

- Paired Networks: Initial / Growth Scenarios have same set of stochastic networks

- Poisson distribution with 40 as mean number of chickens per farm

- 100 Farms

- One initial seeded infection


```{r network-setup}
#Set number of farms and ~ number of chickens per farm
farm_number <- 100
farm_size <- 40

```

#### Parameters

$\beta$ = 1.4456 -- Contact rate implemented alongside $\rho$

$\gamma$ = 0.167 -- Recovery rate

$\mu$ = 0.0 -- Base mortality rate

$\alpha$ = 0.4 -- Disease mortality rate

$\phi$ = 0.0 -- Infectiousness of environmental virions

$\eta$ = 0.0 -- Degradation of environmental virions

$\nu$ = 0.0 -- Update rate of environmental virions

$\sigma$ = 0.0 -- Virion shedding rate

$\omega$ = 0.03 -- Inter-patch movement rate

$\rho$ = 0.8526 -- Contact non-linearity parameter

$\lambda$ = 0.0 -- External force of infection

$\tau$-crit = 0.0 -- Critical surveillance time

$I$-crit = 0.0 -- Threshold for reporting

$\pi$-report = 0.0 -- Reporting probability

$\pi$-detect = 0.0 -- Detection probability

t-detect = variable -- Time to culling

```{r parameter-setup}
  parms = list(
    beta = 1.44456,   #contact rate for direct transmission
    gamma = 0.167,  #recovery rate
    mu = 0,         #base mortality rate
    alpha = 0.4,      #disease mortality rate
    phi = 0,  #infectiousness of environmental virions
    eta = 0,     #degradation rate of environmental virions
    nu =  0.00,    #uptake rate of environmental virion
    sigma = 0,      #virion shedding rate
    omega = 0.03,   #movement rate
    rho = 0.85256,        #contact  nonlinearity 0=dens-dependent, 1=freq-dependent
    lambda = 0,     #force of infection from external sources
    tau_crit = 5,   #critical suveillance time
    I_crit = 1,     #threshold for reporting
    pi_report = 0.9, #reporting probability
    pi_detect = 0.9, #detection probability
    cull_time = 0,   #time to detect (changed in this experiment)
    network_type = "smallworld",
    network_parms = list(dim = 1, size = farm_number, nei = 2.33, p = 0.0596, multiple = FALSE, loops = FALSE),
    stochastic_network = TRUE
    )
```


### Varying culling parameters

In this experiment, the mean number of infections and the duration of the epidemic are plotted against t-detect, which varies as [1,5,10,20,30,40,50].


```{r vary-tdetect}

cull_time_vector <- c(1:20)

results_list <- lapply(cull_time_vector, function(x){
  parms["cull_time"] <- x
  sims <- 100
  g_list <- mclapply(seq_len(sims), function(y){
    patches <- grow_patches_clustered(basic_patches(40,100))
    i_patches <- seed_initial_infection(patches)
    return(mf_sim(init = i_patches, parameters = parms, times=1:365, n_sims = 1))
  }, mc.cores = 20 )

  return(do.call("abind", g_list))
})
```

This plot shows the total number of infections (representing the severity of the outbreak) for each value of t-detect.

```{r infections-plot}
tot_i_list <- lapply(results_list, function(x) get_tot_infections_array(x))
means <- sapply(tot_i_list, function(x) mean(x$total_i))
infection_df <- data.frame(cull_time_vector, mean_infections = means)
ggplot(data = infection_df) + geom_point(aes(x = cull_time_vector, y = mean_infections)) +
  labs(x = "days to culling", y = "mean number of infections")
```

This graph shows the proportion of outbreaks that spread to more than 1 farm for each value of t-detect.

```{r outbreak-proportion}
farm_num <- lapply(results_list, function(x) get_number_farms(x))

outbreak_list <- unlist(lapply(farm_num, function(x){
  return(sum(x > 1)/length(x))
}))

outbreak_df <- data.frame(cull_time_vector, outbreak_list)
outbreaks <- ggplot(data = outbreak_df) +
  geom_point(aes(x = cull_time_vector, y = outbreak_list)) +
  labs(x = "days to culling", y = "proportion of large outbreaks")
plot(outbreaks)
```

These graphs show the runs of each simulation for the different values of t-detect. (Change makegraphs to 1 to see the graphs. I'm trying to combine them into 1 so that a unique panel doesn't print out for each value of t-detect.)
```{r aggregate-plot}

makegraphs <- 0 #toggle to 1 to show graphs

create_graph_panel <- function(result_array, value){

  gdurations <- get_duration_array(result_array)

  gs.df <- get_all_sims("S", result_array)
  gi.df <- get_all_sims("I", result_array)
  gr.df <- get_all_sims("R", result_array)

  gfarm_no <- get_number_farms(result_array)

  gtot_i <- get_tot_infections_array(result_array)

  gsir.df <- ggplot() +
    geom_line(data = gs.df, aes(x = time, y = pop, group = sim), alpha = 0.05, color = "blue") +
    geom_line(data = gi.df, aes(x = time, y = pop, group = sim), alpha = 0.05, color = "red") +
    geom_line(data = gr.df, aes(x = time, y = pop, group = sim), alpha = 0.05, color = "green") +
    labs(title = paste("Time to Culling:",value, "days"), x = "Time", y = "Population") +
    scale_colour_manual(name = "Compartment", values=c(S = "blue", I = "red", R = "green")) +
    theme_minimal()
#plot(gsir.df)

  gtotal_i <- ggplot() +
    geom_histogram(data = gtot_i, aes(x = total_i), bins = 100) +
    labs(title = "Infections", x = "Infections", y = "Number of Simulations") +
    theme_minimal()

  gfarm_numbers <- ggplot() +
    geom_histogram(aes(x = gfarm_no), bins = 100) +
    labs(title = "Farm Spread", x = "Farms Infected", y = "Number of Simulations") +
    coord_flip() +
    theme_minimal()

  gduration <- ggplot() +
    geom_histogram(data = gdurations, aes(x = duration), bins = 100) +
    theme_minimal() +
    labs(title = "Duration of Epidemic", x = "Duration in Days", y = "Number of Simulations")

  lay <- rbind(c(1,1,1,4),
               c(1,1,1,4),
               c(2,2,3,3))

  grid.arrange(gsir.df,gtotal_i,gduration,gfarm_numbers, layout_matrix = lay)

}

if (makegraphs > 0){
graph_panel <- purrr::map2(results_list,cull_time_vector, function(x,y) create_graph_panel(x,y))
}

```



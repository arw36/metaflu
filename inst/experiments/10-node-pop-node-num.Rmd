---
title: "10-node-pop"
author: "Cale Basaraba"
date: "4/26/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=10, fig.height=6, warning = FALSE)
library(metaflu)
library(ggplot2)
library(dplyr)
library(doMC)
library(tidyr)
library(purrr)
library(gridExtra)
library(abind)
#registerDoMC(cores = 20)
#devtools::install_github("renozao/doRNG", force = TRUE)
library(doRNG)
library(feather)
set.seed(123)
P <- rprojroot::find_package_root_file
```

### Introduction

The following document explores increasing population size in nodes versus increasing the number of nodes in the network. 


```{r network-setup}
#Set number of farms and ~ number of chickens per farm

farm_number <- 100
farm_size <- 40

```


```{r parameter-setup}
  parms = list(
    beta = 1.44456,   #contact rate for direct transmission
    gamma = 0.167,  #recovery rate
    mu = 0,         #base mortality rate
    alpha = 0.4,      #disease mortality rate
    phi = 0,  #infectiousness of environmental virions
    eta = 0,     #degradation rate of environmental virions
    nu =  0.00,    #uptake rate of environmental virion
    sigma = 0,      #virion shedding rate
    omega = 0.03,   #movement rate
    rho = 0.85256,        #contact  nonlinearity 0=dens-dependent, 1=freq-dependent
    lambda = 0,     #force of infection from external sources
    tau_crit = 5,   #critical suveillance time
    I_crit = 1,     #threshold for reporting
    pi_report = 0.9, #reporting probability
    pi_detect = 0.9, #detection probability
    cull_time = 5,   #time to detect
    network_type = "smallworld",
    network_parms = list(dim = 1, size = farm_number, nei = 2.33, p = 0.0596, multiple = FALSE, loops = FALSE),
    stochastic_network = TRUE
    )
```


###Parameters

The parameters for these runs:

From 20 to 1500 chickens

From 10 to 750 farms

1000 simulations per parameter set.

$\beta$ = `r parms["beta"]` -- Contact rate

$\gamma$ = `r parms["gamma"]` -- Recovery rate

$\mu$ = `r parms["mu"]` -- Base mortality rate

$\alpha$ = `r parms["alpha"]` -- Disease mortality rate

$\phi$ = `r parms["phi"]` -- Infectiousness of environmental virions

$\eta$ = `r parms["eta"]` -- Degradation of environmental virions

$\nu$ = `r parms["nu"]` -- Update rate of environmental virions

$\sigma$ = `r parms["sigma"]` -- Virion shedding rate

$\omega$ = `r parms["omega"]` -- Inter-patch movement rate

$\rho$ = `r parms["rho"]` -- Contact non-linearity parameter

$\lambda$ = `r parms["lambda"]` -- External force of infection

$\tau$-crit = `r parms["tau_crit"]` -- Critical surveillance time

$I$-crit = `r parms["I_crit"]` -- Threshold for reporting

$\pi$-report = `r parms["pi_report"]` -- Reporting probability

$\pi$-detect = `r parms["pi_detect"]` -- Detection probability

$t_c$-detect = `r parms["cull_time"]` -- Mean Time in Days until Culling

```{r vary-tdetect, include = FALSE, eval = FALSE}

farm_size_vec <- c(50, 100, 200, 500, 1000, 1500)
farm_number_vec <- c(20, 50, 100, 200, 500, 750)

sims <- 1000

size_list <- lapply(farm_size_vec, function(x){
  farm_size <- x
  number_list <- lapply(farm_number_vec, function(y){
    farm_number <- y
    print(paste("Farm Size:",x,"    Farm Number:",y))
    parms$network_parms$size <- farm_size
    r_list <- mclapply(seq_len(sims), function(z){
      patches <- basic_patches(farm_size, farm_number)
      i_patches <- seed_initial_infection(patches)
      return(mf_sim(init = i_patches, parameters = parms, times = 1:365, n_sims = 1))
    }, mc.cores = 20)
    return(r_list)
  })
  return(number_list)
})

saveRDS(size_list, P("inst","size_list.RDS"))



create_dataframe <- function(farm_size){
f_list <- lapply(farm_number_vec, function(x){
  return(readRDS(paste0(farm_size,"chickens",x,"farms.rds")))
})

results_inter <- lapply(seq_along(f_list), function(x){
  arr <- do.call("abind",f_list[[x]])
  df.d <- get_duration_array(arr)
  df.e <- get_exposure(arr)
  df.f <- get_number_farms(arr)
  df.p <- get_proportion_loss(arr)
  df.ef <- get_exposure_fraction(arr)
  df <- full_join(df.d, df.e, by = "sim") %>%
    full_join(df.f, by = "sim") %>%
    full_join(df.p, by = "sim") %>%
    full_join(df.ef, by = "sim")
  df$chickens <- farm_size
  df$farms <- farm_number_vec[x]
  return(df)
})
rm(f_list)
results <- bind_rows(results_inter)
return(results)
}

df_list <- lapply(farm_size_vec, function(x) create_dataframe(x))

grand_df <- bind_rows(df_list)

saveRDS(grand_df, "node_pop_df.rds")

```

```{r visualize-results}

grand_df <- readRDS("node_pop_df.rds")

ggplot(data = grand_df) +
  geom_boxplot(aes(x = as.factor(chickens), y = duration)) +
  facet_wrap(~farms) +
  labs(title = "Duration of Infections by Number of Farms and Chickens", x = "Number of Chickens", y = "Days") +
  theme_minimal()


grand_df$adj_farms <- grand_df$num_farms/grand_df$farms

ggplot(data = grand_df) +
  geom_boxplot(aes(x = as.factor(chickens), y = adj_farms)) +
  facet_wrap(~farms) +
  labs(title = "Proportion of Infected Farms by Number of Farms and Chickens", y = "Proportion of Infected Farms", x = "Number of Chickens per Farm") +
  theme_minimal()

grand_df$inf_exp_adj <- grand_df$inf_exp/grand_df$farms
  
ggplot(data = grand_df) +
  geom_boxplot(aes(x = as.factor(chickens), y = inf_exp_adj)) +
  facet_wrap(~farms) +
  labs(title = "Adjusted Infectious Exposure by Number of Farms and Chickens", y = "Infected Chickens per Farm", x = "Number of Chickens per Farm") +
  theme_minimal()

grand_df$exp_per_day <- grand_df$inf_exp/grand_df$duration

grand_df$exp_per_day_adj <- grand_df$exp_per_day/grand_df$farms

ggplot(data = grand_df) +
  geom_boxplot(aes(x = as.factor(chickens), y = exp_per_day_adj)) +
  facet_wrap(~farms) +
  labs(title = "Adjusted Intensity (infectious chickens / duration) by Number of Farms and Chickens", y = "Infected Chickens/Day/Farm", x = "Number of Chickens per Farm") +
  theme_minimal()


```
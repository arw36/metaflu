---
title: "Additional Graphs"
output: 
  html_document:
    toc: true
    keep_md: true
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(metaflu)
library(ggplot2)
library(plyr)
library(ggraph)
library(dplyr)
library(doMC)
library(foreach)
library(tidyr)
library(purrr)
library(gridExtra)
library(abind)
library(printr)
#registerDoMC(cores = 20)
#devtools::install_github("renozao/doRNG", force = TRUE)
library(doRNG)
set.seed(123)
P <- rprojroot::find_package_root_file
library(parallel)
library(gganimate)
library(grid)
library(igraph)

```

### 3-D Network Animation Example

- The base scenario in this report simulates a network of 200 farms, with around 50 chickens per farm. 

- Each simulation creates a randomly generated network of farms.

- Each simulation seeds one initial infected chicken at a random farm. 

- No culling practices are implemented.

```{r basic-run}
number_of_farms <- 200
number_of_chickens <- 50

  parms = list(
    beta = 1.44456,   #contact rate for direct transmission
    gamma = 0.167,  #recovery rate
    mu = 0,         #base mortality rate
    alpha = 0.4,      #disease mortality rate
    phi = 0,  #infectiousness of environmental virions
    eta = 0,     #degradation rate of environmental virions
    nu =  0.00,    #uptake rate of environmental virion
    sigma = 0,      #virion shedding rate
    omega = 0.03,   #movement rate
    rho = 0.85256,        #contact  nonlinearity 0=dens-dependent, 1=freq-dependent
    lambda = 0,     #force of infection from external sources
    tau_crit = 2,   #critical suveillance time
    I_crit = 5,     #threshold for reporting
    pi_report = 0, #reporting probability
    pi_detect = 1, #detection probability
    cull_time = 10,#time to culling
    network_type = "smallworld",
    network_parms = list(dim = 1, size = number_of_farms, nei = 2.33, p = 0.0596, multiple = FALSE, loops = FALSE),
    stochastic_network = TRUE
    )
  
#create patches
sims <- 100

initial_cond_list <- lapply(seq_len(sims), function(x){
  return(basic_patches(number_of_chickens, number_of_farms))
})

base_seeded_list <- lapply(initial_cond_list, function(x){
  return(seed_initial_infection(x))
})

network_list <- lapply(seq_len(sims), function(x){
  return(make_net(parms$network_type, parms$network_parms))
})

basic_results_list <- pmap(list(base_seeded_list,network_list), function(x,y){
  parms$chi <- y
  return(mf_sim(init = x, parameters = parms, times = 1:365))
})

basic_results <- do.call("abind", basic_results_list)
  
#rm(basic_results_list)

```

- The animation below is an example of the base network scenario with no culling. 

  - This graphic shows a simulation run that resulted in a long epidemic. 
  
  - Nodes represent farms, with edges illustrating connections between farms. 

  - Black nodes represent farms with a normal chicken population, while red nodes indicate farms
  with at least one infected chicken. 
  
  
```{r basic-vis}

durs <- get_duration_array(basic_results) %>%
  arrange(desc(duration))

high_duration_sim <- durs$sim[1]

create_graphjs(basic_results_list[[high_duration_sim]], high_duration_sim)

```


### 3-D Network With Culling

- The animation below illustrates the spread of a long duration epidemic in a random-growth scenario with culling implemented.

 - Nodes represent farms, with edges illustrating connections between farms. 

  - Black nodes represent farms with a normal chicken population, while red nodes indicate farms
  with at least one infected chicken. Blue nodes represent farms that have been culled. 

```{r culling-graph-random}

parms["cull_time"] <- 2
parms["pi_report"] <- 1

growth_list <- lapply(initial_cond_list, function(x) {
  return(grow_patches_random(x))})

seeded_glist <- lapply(growth_list, function(x){
  return(seed_initial_infection(x))
})

growth_results_list <- pmap(list(seeded_glist,network_list), function(x,y){
  parms$chi <- y
  return(mf_sim(init = x, parameters = parms, times = 1:365))
})
  
g_results <- do.call("abind", growth_results_list)

```

```{r growth-cull-vis}

gdurs <- get_duration_array(g_results) %>%
  arrange(desc(duration))

high_duration_sim <- gdurs$sim[1]

create_graphjs(growth_results_list[[high_duration_sim]], high_duration_sim)

```